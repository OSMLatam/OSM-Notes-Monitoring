# Vulnerability Scanning Guide

**Version:** 1.0.0  
**Last Updated:** 2025-12-31  
**Component:** Security

## Overview

This guide explains how to use the vulnerability scanning script to identify security vulnerabilities in the OSM-Notes-Monitoring system. Regular vulnerability scanning is essential for maintaining a secure monitoring infrastructure.

## Table of Contents

1. [Introduction](#introduction)
2. [What is Vulnerability Scanning?](#what-is-vulnerability-scanning)
3. [Running the Scan](#running-the-scan)
4. [Understanding Results](#understanding-results)
5. [Remediation](#remediation)
6. [Best Practices](#best-practices)
7. [Automated Scanning](#automated-scanning)
8. [Troubleshooting](#troubleshooting)

---

## Introduction

The vulnerability scanning script (`scripts/vulnerability_scan.sh`) performs automated checks for:

- **Outdated Software**: Checks versions of bash, PostgreSQL, curl, and other dependencies for known vulnerabilities
- **Hardcoded Secrets**: Scans for passwords, API keys, and tokens in code
- **Insecure Configurations**: Identifies SQL injection, command injection, and other security risks
- **File Permissions**: Checks for world-writable files and incorrect permissions
- **System Updates**: Identifies available security updates

## What is Vulnerability Scanning?

Vulnerability scanning is the process of identifying security weaknesses in:

1. **Dependencies**: External tools and libraries with known CVEs
2. **Code**: Insecure coding patterns and practices
3. **Configuration**: Misconfigured settings that expose risks
4. **Infrastructure**: System-level vulnerabilities

### Types of Vulnerabilities

- **Critical**: Immediate threat requiring urgent action (e.g., Shellshock, EOL software)
- **High**: Significant risk requiring prompt attention (e.g., outdated PostgreSQL, command injection)
- **Medium**: Moderate risk that should be addressed (e.g., SQL injection patterns, package updates)
- **Low**: Minor issues that can be addressed during regular maintenance
- **Info**: Informational findings that don't pose immediate risk

---

## Running the Scan

### Basic Usage

```bash
# Run vulnerability scan
./scripts/vulnerability_scan.sh
```

### Output

The script generates:

1. **Console Output**: Colored output showing findings in real-time
2. **Report File**: Detailed text report in `reports/vulnerability_scan_YYYYMMDD_HHMMSS.txt`

### Example Output

```
Vulnerability Scan for OSM-Notes-Monitoring
Started at: Wed Dec 31 10:30:00 UTC 2025

Checking bash version...
  ✓ Bash version 5.1.16 appears safe
Checking PostgreSQL version...
  ✓ PostgreSQL version 14.9 appears current
Checking curl version...
  ✓ curl version 7.81.0 appears current
Scanning for hardcoded secrets...
  ✓ No obvious hardcoded secrets found
Checking file permissions...
  ✓ File permissions appear secure
Checking for insecure configurations...
  ✓ No obvious insecure configurations found
Checking for available package updates...
  ✓ System packages appear up to date

==========================================
Vulnerability Scan Summary
==========================================

Critical: 0
High: 0
Medium: 0
Low: 0
Info: 0

✓ No vulnerabilities found!
Full report saved to: reports/vulnerability_scan_20251231_103000.txt
```

---

## Understanding Results

### Severity Levels

#### Critical Vulnerabilities

Examples:
- **Shellshock (CVE-2014-6271)**: Bash versions < 4.3.27
- **EOL Software**: PostgreSQL < 11, bash < 4.1
- **Hardcoded Secrets**: Passwords or API keys in code

**Action**: Address immediately, may require system updates or code changes.

#### High Vulnerabilities

Examples:
- **Outdated PostgreSQL**: Versions with known security issues
- **Command Injection**: Unsafe use of `eval` or command substitution
- **World-Writable Files**: Files accessible by all users

**Action**: Address within 24-48 hours.

#### Medium Vulnerabilities

Examples:
- **SQL Injection Patterns**: Potential injection risks
- **Outdated Packages**: Available security updates
- **Insecure Configurations**: Misconfigured settings

**Action**: Address within 1-2 weeks.

#### Low Vulnerabilities

Examples:
- **Missing Execute Permissions**: Scripts referenced but not executable
- **Informational Findings**: Non-critical issues

**Action**: Address during regular maintenance.

### Report Structure

The report file contains:

1. **Header**: Scan timestamp and project information
2. **Findings**: Detailed list of vulnerabilities with:
   - Severity level
   - Component/file affected
   - Description
   - Recommendation
3. **Summary**: Count of vulnerabilities by severity

---

## Remediation

### Updating Software

#### Bash

```bash
# Check current version
bash --version

# Update via package manager
sudo apt-get update && sudo apt-get upgrade bash
# or
sudo yum update bash
```

#### PostgreSQL

```bash
# Check current version
psql --version

# Update PostgreSQL (varies by distribution)
# Ubuntu/Debian
sudo apt-get update && sudo apt-get upgrade postgresql

# CentOS/RHEL
sudo yum update postgresql-server
```

#### curl

```bash
# Check current version
curl --version

# Update via package manager
sudo apt-get update && sudo apt-get upgrade curl
# or
sudo yum update curl
```

### Fixing Hardcoded Secrets

1. **Identify the secret**: Review the scan report
2. **Move to environment variables**:
   ```bash
   # Before (insecure)
   PASSWORD="secret123"
   
   # After (secure)
   export PASSWORD="${PASSWORD:-}"
   ```
3. **Use configuration files**: Store secrets in `etc/properties.sh` (not in git)
4. **Update documentation**: Document required environment variables

### Fixing File Permissions

```bash
# Remove world-writable permissions
chmod 640 insecure_file.sh

# Set correct permissions for scripts
chmod 755 bin/monitor/*.sh

# Set correct permissions for config files
chmod 600 etc/properties.sh
```

### Fixing Insecure Configurations

#### SQL Injection

```bash
# Before (insecure)
query="SELECT * FROM users WHERE id = ${user_id}"

# After (secure)
query="SELECT * FROM users WHERE id = \$1"
psql -c "${query}" -v user_id="${user_id}"
```

#### Command Injection

```bash
# Before (insecure)
eval "command ${user_input}"

# After (secure)
# Validate and sanitize input
if [[ "${user_input}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    command "${user_input}"
else
    echo "Invalid input"
fi
```

---

## Best Practices

### Regular Scanning

1. **Frequency**: Run scans weekly or before deployments
2. **Automation**: Integrate into CI/CD pipeline
3. **Documentation**: Track remediation progress

### Remediation Priority

1. **Critical**: Address immediately
2. **High**: Address within 24-48 hours
3. **Medium**: Address within 1-2 weeks
4. **Low**: Address during regular maintenance

### Prevention

1. **Keep Dependencies Updated**: Regularly update system packages
2. **Code Review**: Review code for security issues before merging
3. **Use Secrets Management**: Never commit secrets to version control
4. **Follow Security Guidelines**: Adhere to security best practices
5. **Monitor CVEs**: Subscribe to security advisories for dependencies

### Integration with Security Audit

The vulnerability scan complements the security audit (`scripts/security_audit.sh`):

- **Security Audit**: Focuses on code patterns and configurations
- **Vulnerability Scan**: Focuses on known CVEs and outdated software

Run both regularly for comprehensive security coverage.

---

## Automated Scanning

### Cron Job

Add to crontab for weekly scans:

```bash
# Run vulnerability scan every Sunday at 2 AM
0 2 * * 0 /path/to/OSM-Notes-Monitoring/scripts/vulnerability_scan.sh >> /var/log/vuln_scan.log 2>&1
```

### CI/CD Integration

Example GitHub Actions workflow:

```yaml
name: Vulnerability Scan

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run vulnerability scan
        run: ./scripts/vulnerability_scan.sh
      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: vulnerability-report
          path: reports/vulnerability_scan_*.txt
```

### Alerting on Critical Findings

Modify the script to send alerts:

```bash
# After generate_summary()
if [[ ${VULN_CRITICAL} -gt 0 ]] || [[ ${VULN_HIGH} -gt 0 ]]; then
    # Send alert via email or Slack
    send_alert "monitoring" "critical" "security" "Critical vulnerabilities found in scan"
fi
```

---

## Troubleshooting

### Script Fails to Run

**Issue**: Permission denied

```bash
# Solution: Add execute permission
chmod +x scripts/vulnerability_scan.sh
```

### Cannot Determine Version

**Issue**: Command not found or version detection fails

**Solution**: Ensure required tools are installed and in PATH:
- `bash`
- `psql` (if using PostgreSQL)
- `curl` (if using HTTP checks)

### False Positives

**Issue**: Scan reports vulnerabilities that aren't applicable

**Solution**: Review findings carefully:
- Some patterns may be false positives (e.g., test data)
- Update script patterns if needed
- Document exceptions

### Package Update Check Requires Sudo

**Issue**: Package update check skipped due to missing sudo access

**Solution**: Either:
1. Run script with sudo (not recommended for security)
2. Skip package update check (already handled)
3. Run package updates separately with appropriate permissions

---

## Related Documentation

- [Security Audit Guide](./SECURITY_AUDIT_GUIDE.md): Code-level security checks
- [Security Best Practices](./SECURITY_BEST_PRACTICES.md): General security guidelines
- [Security Incident Response](./SECURITY_INCIDENT_RESPONSE_RUNBOOK.md): Responding to security incidents

---

## Summary

Vulnerability scanning is a critical component of maintaining a secure monitoring system. Regular scans help identify and remediate security issues before they can be exploited. Use this guide to:

1. Run scans regularly
2. Understand and prioritize findings
3. Remediate vulnerabilities promptly
4. Integrate scanning into your workflow

For questions or issues, refer to the troubleshooting section or review the security audit guide for complementary checks.
